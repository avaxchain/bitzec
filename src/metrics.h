// Copyright (c) 2016 The Zcash developers
// Distributed under the MIT software license, see the accompanying
// file COPYING or http://www.opensource.org/licenses/mit-license.php.

#include "uint256.h"

#include <atomic>
#include <mutex>
#include <string>

struct AtomicCounter {
    std::atomic<uint64_t> value;

    AtomicCounter() : value {0} { }

    void increment(){
        ++value;
    }

    void decrement(){
        --value;
    }

    int get() const {
        return value.load();
    }
};

class AtomicTimer {
private:
    std::mutex mtx;
    uint64_t threads;
    int64_t start_time;
    int64_t total_time;

public:
    AtomicTimer() : threads(0), start_time(0), total_time(0) {}

    /**
     * Starts timing on first call, and counts the number of calls.
     */
    void start();

    /**
     * Counts number of calls, and stops timing after it has been called as
     * many times as start().
     */
    void stop();

    bool running();

    uint64_t threadCount();

    double rate(const AtomicCounter& count);
};

extern AtomicCounter transactionsValidated;
extern AtomicCounter ehSolverRuns;
extern AtomicCounter solutionTargetChecks;
extern AtomicTimer miningTimer;

void TrackMinedBlock(uint256 hash);

void MarkStartTime();
double GetLocalSolPS();
int EstimateNetHeightInner(int height, int64_t tipmediantime,
                           int heightLastCheckpoint, int64_t timeLastCheckpoint,
                           int64_t genesisTime, int64_t targetSpacing);

void TriggerRefresh();

void ConnectMetricsScreen();
void ThreadShowMetricsScreen();

/**
 * bitcoin image: https://upload.wikimedia.org/wikipedia/commons/thumb/4/46/Bitcoin.svg/200px-Bitcoin.svg.png
 * License: CC BY-SA 3.0
 *
 * Rendering options:
 *
 */
const std::string METRICS_ART =
"[0;34;40m       [0;31;40m .[0;32;40m   [0;34;40m...[0;32;40m   [0;31;40m .[0;32;40m [0;34;40m             .[0;32;40m:[0;1;30;40m@X[0;34;40m;[0;32;40mt[0;34;40mt[0;1;30;40mX@[0;32;40m;[0;31;40m:[0;34;40m:[0;32;40m.[0;31;40m    [0;34;40m      [0;32;40m     [0;34;40m [0;32;40m           .[0;34;40m     [s\n"
"[u     [0;31;40m  [0;1;30;40mX[0;5;33;40m8@[0;1;30;43m8[0;37;43mX[0;5;33;43m.[0;1;31;43m8[0;33;47m8[0;1;33;43m.[0;33;47m8[0;1;30;43m8[0;5;31;40m@[0;1;30;40mX[0;32;40m [0;31;40m     [0;34;40m     .[0;32;40m;[0;31;40mt[0;34;40mt[0;32;40m;[0;31;40m:[0;34;40m:[0;31;40m:[0;34;40m;[0;31;40m;[0;32;40m:[0;34;40m.:[0;32;40m;[0;31;40mt[0;34;40mt[0;32;40m;[0;31;40m.[0;34;40m       .[0;32;40mS[0;5;32;40mS[0;5;33;40m  \n" [0;5;32;40mS[0;32;40m8[0;34;40m;[0;31;40m.[0;32;40m.[0;31;40m.[0;32;40m@[0;5;36;40m;[0;5;33;40m.  [0;5;32;40m@[0;32;40mX[0;31;40m:[0;34;40m.[0;32;40m   [s
"[u[0;34;40m   [0;32;40m [0;34;40m:[0;5;33;40mX[0;37;43m@[0;5;33;43m [0;5;33;41m.[0;5;33;43m [0;5;1;33;41m8[0;5;1;31;43m8[0;5;37;47mt8[0;5;1;31;43m8[0;1;33;47mS[0;5;37;43m8[0;5;1;31;43m88[0;5;37;43m@[0;37;43m@[0;5;33;40mS[0;31;40mS[0;34;40m:[0;32;40m.[0;31;40m   [0;34;40m .[0;32;40m;[0;31;40mt[0;34;40mt[0;32;40mt[0;5;35;40mS[0;5;37;40m@[0;1;37;47m;[0;5;37;47m8X%X@[0;1;37;47mX[0;1;30;47mt[0;5;35;40m\n" [0;1;30;40m@[0;32;40m:[0;34;40m;[0;31;40m;[0;32;40mt[0;34;40m:[0;31;40m.[0;32;40m  [0;34;40m:[0;1;30;42mX8[0;1;32;47mX[0;1;37;47m [0;1;32;47mS[0;1;37;47m [0;1;32;47mS[0;1;37;47m [0;1;32;47mX[0;5;32;42m:[0;5;32;40m8[0;30;42m8[0;5;36;40m%[0;1;32;47mX[0;1;33;47m%[0;1;36;47mX[0;5;37;43m8[0;5;37;46m8[0;1;33;47mX[0;5;37;42m8[0;5;32;42m8[0;5;32;40m8[0;34;40m:[0;31;40m.[0;34;40m [s
"[u  [0;32;40m [0;34;40m;[0;33;47m8[0;5;1;31;43m@[0;5;1;33;41m8[0;1;33;47m8[0;5;1;31;43m8[0;1;31;47m8[0;5;1;31;43m8[0;1;33;47m8[0;5;37;47m;8[0;5;1;33;41m8[0;5;37;47m@ [0;5;37;43m8[0;5;1;33;41m@8[0;5;1;31;43m88[0;1;37;47m [0;31;40mS[0;32;40m.[0;34;40m   [0;32;40m:[0;1;30;40mX[0;34;40m;[0;32;40m:[0;1;30;40mX[0;1;37;47mX[0;5;37;47m:.:.[0;5;36;40mt[0;31;40m [0;32;40m;[0;5;37;47m@ . .[0;5;35;40m [0;31;40m.[0;34;40mt[0;31;40m;[0;1;30;40mS[0;32;40m \n" .[0;5;32;40m8[0;1;32;42m;[0;5;32;42m [0;5;37;42m8[0;5;1;33;42mX[0;5;1;36;42m8[0;5;1;33;42m8[0;5;1;32;46m8[0;5;1;33;42m8[0;5;1;36;42m8[0;1;32;47m8[0;5;32;42m:;[0;5;33;42m [0;5;37;42m8[0;5;1;36;42mX[0;5;1;33;42m8[0;5;1;32;46m8[0;5;1;33;42m8[0;5;1;36;42m8[0;1;33;47mX[0;5;32;42m [0;1;32;42m%[0;5;32;40m8[0;34;40m  [s
"[u[0;31;40m  [0;1;30;40mX[0;33;47m8[0;5;1;31;43m8[0;5;33;43m [0;5;33;41m [0;5;37;43m8[0;5;37;47m;:X8%X[0;5;1;33;47m8[0;5;37;47m.S[0;5;37;43m8[0;5;1;33;41m8[0;5;37;43m8[0;5;1;33;41m8[0;5;37;43m@[0;5;1;33;41m8[0;33;47m8[0;5;30;40m8[0;31;40m. ;[0;34;40m%[0;32;40m;[0;31;40m:[0;5;35;40m [0;5;37;47m% :[0;1;30;47m.%t[0;1;30;40m8[0;31;40m.[0;34;40m;[0;1;30;47m@;S[0;1;37;47m@[0;5;37;47m \n" [0;1;37;47m.[0;1;30;40m@[0;32;40m:[0;34;40m;[0;32;40mt[0;31;40m:[0;34;40m;[0;1;30;42mt[0;1;32;42m8[0;5;32;42m.[0;5;36;42m [0;5;1;36;42mX[0;5;1;33;42m@[0;5;1;36;42mX[0;5;1;33;42mX[0;5;1;36;42mS[0;5;1;33;42m@[0;5;32;42m    [0;5;1;33;42mX[0;5;1;36;42mS[0;5;1;33;42mS[0;5;1;36;42m%[0;5;1;33;42mS[0;5;1;36;42m%[0;5;32;42m  [0;1;32;42m8[0;1;30;42mX[0;32;40mt[0;34;40m:[s
"[u[0;31;40m [0;34;40mt[0;5;37;43m@[0;5;1;33;41m8[0;5;1;31;43m8[0;1;31;47m8[0;5;33;43m [0;5;33;41m [0;5;33;43m [0;5;37;43m8[0;5;37;47mt:.[0;5;1;33;47m8[0;1;33;47mS[0;5;37;47m88  S[0;5;37;43m8[0;5;1;33;41mX[0;5;1;31;43m@8[0;1;33;47m8[0;31;40mS[0;34;40m:[0;32;40mt[0;31;40mt[0;34;40m:[0;1;30;47m%[0;5;37;47m   ;[0;1;30;40mX[0;32;40m. [0;31;40m.[0;32;40m:[0;31;40m:[0;34;40m.[0;32;40m:[0;34;40m.[0;1;30;47m@[0;5;37;47m :\n" 8[0;1;30;40m8[0;32;40m:[0;34;40mt[0;31;40mt[0;32;40mS[0;1;30;42m;[0;5;32;42m@:                   8[0;1;30;42mt[0;32;40mS[0;31;40m:[s
"[u[0;34;40m [0;5;33;40m:[0;5;1;31;43m8[0;5;37;43mX[0;5;1;33;41m8[0;5;1;31;43m8[0;5;37;43m@[0;5;1;31;43m8[0;5;33;41m [0;5;37;43m8[0;5;37;47m  S[0;5;1;31;43m8[0;5;1;33;41m8[0;5;1;31;43m88[0;5;37;47mX  8[0;5;1;31;43m888[0;5;37;43m8[0;5;35;40mt[0;31;40mS[0;34;40mS[0;32;40m;[0;5;35;40m%[0;5;37;47m; . .[0;1;30;47m.%t:X[0;34;40m;[0;32;40m;[0;31;40m:[0;5;30;40m8[0;5;37;47m% ..\n" [0;1;30;47m:[0;31;40m.[0;32;40m;[0;1;30;40m@8[0;1;30;42m%[0;1;32;42m8[0;5;32;42mt                  :[0;1;32;42m8[0;1;30;42m@[0;1;30;40m@[0;34;40m [s
"[u.[0;37;43m8[0;5;1;31;43m8[0;5;1;33;41m8[0;5;37;43m8[0;5;1;33;41m@8[0;5;37;43m8[0;5;1;31;43m8[0;1;37;47m [0;5;37;47m:.S[0;5;37;43m8[0;5;1;31;43m8[0;5;37;43m88[0;5;37;47m: .8[0;5;1;33;41m8[0;5;1;31;43m8[0;1;31;47m8[0;5;1;31;43m8[0;33;47m8[0;31;40m@[0;32;40m%[0;31;40m.[0;1;30;47m8[0;5;37;47m .   .. [0;1;37;47m%[0;5;30;40m8[0;32;40m:[0;34;40m:[0;5;35;40m;[0;5;37;47m@.  . %[0;1;30;40mS[0;34;40m.t[0;31;40m;[0;1;30;42m8[0;1;32;42m%[0;5;32;42m8;            \n"     8[0;1;32;42mX[0;5;32;40m8[0;34;40m  [s
"[u:[0;33;47m8[0;5;1;31;43m88[0;5;1;33;41m8[0;5;37;43m8[0;5;1;33;41m8[0;5;1;31;43m88[0;5;37;47m8..@88:  .8[0;5;1;33;41m8[0;5;1;31;43m8@@8[0;1;33;47m8[0;34;40mX[0;31;40m%[0;34;40m.[0;1;37;47m.[0;5;37;47m . . .;[0;5;37;40mS[0;34;40m..[0;31;40mt[0;1;30;47mt[0;5;37;47m:.    ..[0;5;30;40m8[0;31;40m [0;32;40mt[0;34;40m;[0;31;40m:[0;1;30;40m8[0;1;30;42m@[0;5;32;42m@S.             %[0;1;32;42m8[0;1;30;42m8[0;1;30;40m@[0;32;40m [0;34;40m  [s\n"
"[u.[0;37;43m8[0;5;1;31;43m8[0;1;33;47m8[0;5;1;33;41m8[0;5;1;31;43m8[0;1;33;47m8[0;5;1;33;41m8[0;5;37;43m8[0;5;37;47m8: [0;5;37;43m8[0;5;1;33;41m8[0;5;1;31;43m8[0;5;1;33;41m8[0;5;37;47m88S;8[0;5;1;31;43m88[0;5;37;43m8[0;5;1;33;41m8[0;33;47m8[0;31;40m8[0;34;40mt[0;32;40m:[0;1;30;47m8[0;5;37;47m..  . [0;5;36;40m [0;32;40m.[0;34;40m:[0;32;40m:[0;1;37;47mt[0;5;37;47m .  . .\n" X[0;34;40m;[0;31;40m.[0;1;30;40mX[0;31;40m:[0;34;40m.[0;32;40m:t[0;5;32;40m@[0;1;32;42m8[0;5;32;42m@;          ;@[0;1;32;42m@[0;5;32;40mX[0;32;40mX:[0;34;40m.[0;31;40m [0;34;40m [s
"[u [0;5;33;40m.[0;5;1;31;43m8[0;5;1;33;41m8[0;5;37;43m8[0;5;1;33;41m@[0;5;1;31;43m8[0;1;33;47m8[0;5;1;33;41m8[0;5;37;47m  ;[0;5;1;31;43m8888[0;5;1;33;41m8[0;5;37;47mt .t[0;5;1;31;43m88[0;5;1;33;41m8[0;5;37;43m8[0;1;30;45m8[0;31;40m%[0;32;40m%[0;34;40m:[0;5;30;40m8[0;5;37;47m%.. t[0;5;36;40m [0;34;40m.[0;32;40m:[0;31;40m:[0;5;30;40mX[0;5;37;40mX[0;5;36;40m [0;5;37;40m@[0;5;36;40m [0;1;30;47m:[0;5;37;47m ..\n" [0;1;30;47m8[0;32;40m.[0;34;40m:[0;1;30;40mX[0;32;40m.[0;34;40m .[0;31;40m.[0;32;40m;[0;5;32;40m8[0;1;30;42m%[0;5;32;42m8X;     .;X[0;1;32;42m8[0;1;30;42m8@[0;31;40m:[0;34;40m:[0;31;40m.   [s
"[u S[0;1;30;47mX[0;5;1;31;43m8[0;5;1;33;41m8[0;5;37;43m@[0;1;37;47m.[0;5;37;47m.    @888: ..[0;5;37;43m8[0;5;1;33;41m8[0;5;37;43m8[0;5;1;33;41m8[0;33;47m8[0;31;40m8[0;32;40m:[0;1;30;40mX[0;31;40m:[0;34;40m.[0;5;30;40mS[0;5;37;47mS. [0;1;37;47m%[0;32;40m [0;34;40m;[0;32;40m;[0;34;40m;[0;32;40m:[0;34;40m;[0;32;40m;[0;34;40mt[0;32;40m:[0;5;35;40m [0;5;37;47m : [0;1;30;47mX[0;32;40m.[0;34;40m:[0;32;40mt[0;31;40m;[0;34;40m:[0;32;40m.[0;31;40m\n" [0;34;40m.[0;31;40m.[0;34;40m [0;31;40m.[0;1;30;40m@[0;1;30;42mX[0;5;32;42m8@;::t@[0;1;32;42m8[0;1;30;42m8X[0;31;40m.[0;34;40m..[0;31;40m.[0;34;40m    [s
"[u [0;31;40m.S[0;1;33;47mS[0;5;1;31;43m8[0;5;1;33;41m8[0;5;1;31;43m888[0;5;37;47m8tX@..::;[0;5;1;33;47m@[0;5;1;31;43m888[0;5;1;33;41m8[0;1;37;47m [0;30;41m%[0;32;40m.[0;31;40m.[0;34;40m:[0;1;30;40mX[0;32;40m.[0;34;40m.[0;5;30;40m8[0;5;37;47mS t@XS[0;5;35;40mt[0;32;40m ;[0;1;37;47m8[0;5;37;47mS@S  [0;1;30;47m8[0;34;40m :[0;31;40mt[0;1;30;40m@[0;34;40m.[0;32;40m [0;31;40m   [0;34;40m  \n" [0;32;40m:.[0;5;32;40m8[0;1;32;42mS[0;5;32;42m8SS8[0;1;32;42mX[0;5;32;40mX[0;34;40m.[0;31;40m [0;34;40m [0;31;40m  [0;34;40m     [s
"[u .[0;31;40m.[0;1;30;40m8[0;1;30;47m8[0;5;1;31;43m88[0;5;37;43m8[0;5;1;33;41m@[0;5;37;47m8;[0;5;1;31;43mXX[0;5;37;47m [0;5;1;33;47m8[0;5;1;33;41m8[0;5;1;31;43m@8888[0;1;33;47mX[0;1;31;47m8[0;1;30;41m8[0;32;40m.[0;34;40m.[0;32;40m [0;31;40m.[0;32;40m.[0;34;40mt[0;32;40m;[0;31;40m.[0;1;30;40mS[0;1;30;47m8[0;1;37;47m@[0;5;37;47m. .[0;5;37;40m8[0;5;33;40m [0;5;35;40m [0;5;37;47m;. S[0;1;30;47m.[0;5;36;40m%[0;31;40m .[0;32;40mt[0;34;40mt[0;32;40m. \n" [0;31;40m    [0;34;40m   [0;31;40m .[0;1;30;40m@[0;1;30;42mX[0;1;32;42m@S[0;1;30;42m@[0;1;30;40m@[0;32;40m:[0;31;40m.[0;34;40m  [0;31;40m  [0;34;40m     [s
"[u [0;32;40m [0;31;40m.;%[0;5;30;40mX[0;5;35;40m;[0;5;1;33;41m8[0;5;37;43m@[0;5;1;33;41m8[0;5;37;43m8[0;5;1;31;43m8[0;5;37;43m8[0;5;37;47m8[0;5;1;31;43m8888[0;5;37;43m8[0;1;31;47mX[0;33;47m8[0;35;41mt[0;31;40m:[0;32;40m.    [0;31;40m..:[0;34;40mt[0;32;40mt[0;34;40m:[0;31;40m.[0;1;30;40mX[0;5;33;40m;[0;5;36;40m [0;1;30;47m%%%[0;5;37;40m8[0;5;35;40m [0;5;30;40m8[0;34;40m:[0;31;40m..:[0;34;40mt[0;31;40m;[0;32;40m:[0;31;40m.[0;32;40m  [0;31;40m   \n" [0;34;40m     [0;32;40m:;[0;5;32;40m8[0;1;30;42mX[0;31;40m:[0;32;40m:[0;34;40m.[0;31;40m [0;34;40m   [0;31;40m  [0;34;40m    [s
"[u   [0;31;40m  ;t[0;34;40m%[0;1;30;41m8[0;5;33;40m [0;5;37;43m8[0;5;37;41m8[0;5;1;31;43m88[0;5;37;43m88[0;1;31;47mX[0;35;47m@[0;1;30;41m8[0;31;40m8;[0;34;40m [0;32;40m      ...[0;31;40m:[0;34;40m;[0;1;30;40m@[0;32;40m;[0;34;40m;:[0;32;40m;[0;34;40m.[0;31;40m [0;34;40m .:[0;32;40m;[0;31;40m;[0;1;30;40mX[0;34;40m;[0;32;40m;[0;31;40m:[0;32;40m.[0;34;40m.[0;32;40m    [0;31;40m   [0;34;40m     .[0;31;40m :[0;34;40m;[0;31;40m.[0;34;40m.[0;31;40m  \n" [0;34;40m        [s
"[u   [0;31;40m  [0;34;40m [0;31;40m..:@@[0;1;30;41m8[0;5;30;40mS[0;35;41m@[0;30;41m88[0;31;40m@%:[0;34;40m [0;31;40m [0;34;40m [0;31;40m [0;32;40m     [0;34;40m  .[0;32;40m.[0;31;40m..:[0;32;40m:[0;31;40mt[0;34;40m%[0;32;40mt[0;31;40m;[0;34;40m;[0;32;40mt[0;31;40m%[0;34;40m%[0;32;40m;[0;31;40m:[0;32;40m:[0;31;40m.[0;34;40m.[0;32;40m      [0;31;40m   [0;34;40m    [0;31;40m  [0;34;40m .[0;31;40m.[0;34;40m [0;32;40m  [0;31;40m  [0;34;40m        [s\n"
"[u   [0;31;40m [0;34;40m   ..... :;;.    [0;31;40m   [0;32;40m    [0;34;40m  [0;31;40m  [0;32;40m .[0;34;40m..[0;32;40m:[0;31;40m:[0;34;40m:[0;32;40m.[0;31;40m:[0;34;40m:[0;32;40m:[0;31;40m.[0;34;40m..[0;31;40m [0;34;40m [0;32;40m        [0;31;40m  [0;34;40m    [0;31;40m    [0;34;40m  [0;32;40m [0;31;40m    [0;34;40m       [s\n"
"[u";
